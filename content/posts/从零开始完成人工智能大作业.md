---
title: "ä»é›¶å¼€å§‹å®Œæˆäººå·¥æ™ºèƒ½å¤§ä½œä¸š"
date: 2020-05-18T12:53:32+08:00
draft: false
tags: ["CNN","ResNet","å›¾åƒåˆ†ç±»","PyTorch","å·ç§¯ç¥ç»ç½‘ç»œ"]
categories: ["æ­£ç»äº‹"]
series: ["è¸©å‘","ä½œä¸š"]
description: "å¹´è½»äººçš„ç¬¬ä¸€ä¸ªå·ç§¯ç¥ç»ç½‘ç»œå·¥ç¨‹"
---

## å†™åœ¨å‰é¢

2020å¹´5æœˆ6æ—¥ï¼Œæœ€åä¸€èŠ‚äººå·¥æ™ºèƒ½è¯¾ä¸Šï¼Œè€å¸ˆå®£å¸ƒå°†æœŸæœ«è€ƒè¯•æ”¹æˆå¤§ä½œä¸šçš„å½¢å¼ï¼ˆå…¶å®ä¹‹å‰å°±è¯´è¿‡ï¼Œä½†æ˜¯å…·ä½“æ˜¯å“ªå¤©æˆ‘å¿˜äº†ï¼‰ï¼Œè¦æ±‚ä½¿ç”¨ cnn ç½‘ç»œå’Œ pytorch æ¡†æ¶å®Œæˆå¸ƒç½®çš„å‡ é¡¹ä»»åŠ¡ä¹‹ä¸€ã€‚

ç›´åˆ°è¿™ä¸€å¤©ï¼Œæˆ‘ä»¬æ‰çœŸæ­£äº†è§£äººå·¥æ™ºèƒ½å¯¼è®ºçš„çœŸæ­£å«ä¹‰ï¼Œä¸æ˜¯å…¥é—¨ï¼Œè€Œæ˜¯è‡ªå·±åŠ¨æ‰‹å†™å®é™…é¡¹ç›®ã€‚æ²¡åŠæ³•ï¼Œé›¶åŸºç¡€çš„æˆ‘åªèƒ½é€‰æ‹©ä¸€ä¸ªæœ€ç®€å•çš„å›¾ç‰‡åˆ†ç±»æ¥åšä¸€åšï¼Œè¿™ç¯‡æ–‡ç« ä¹Ÿæ˜¯è®°å½•ä¸€ä¸‹ï¼Œå¦‚æœä»¥åæœ‰éœ€è¦çš„è¯è¿˜å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚

**ç°åœ¨å¯ä»¥åœ¨ [Github](https://github.com/masterenlu/Chineses_Traffic_Signs_Classify) ä¸Šæ‰¾åˆ°è¿™ä¸ªå·¥ç¨‹**

## å…³äº CNN

é¦–å…ˆè¦åšçš„å°±æ˜¯äº†è§£éœ€è¦ç”¨åˆ°çš„æ¡†æ¶å’Œç½‘ç»œã€‚

è¦æ±‚ä½¿ç”¨ cnn ç½‘ç»œæ¥å®Œæˆä»»åŠ¡ï¼Œä½†æ˜¯ä¹‹å‰ä¸Šè¯¾åªè®²è¿‡ç¥ç»å…ƒç½‘ç»œï¼ˆnnï¼‰,æ‰€ä»¥è¿™é‡Œé¡ºæ‰‹å°±æ‰“å¼€äº†ä¸€ä¸ª[ç»´åŸºç™¾ç§‘](https://zh.wikipedia.org/wiki/å·ç§¯ç¥ç»ç½‘ç»œ)

> **å·ç§¯ç¥ç»ç½‘ç»œ**ï¼ˆConvolutional Neural Network, **CNN**ï¼‰æ˜¯ä¸€ç§[å‰é¦ˆç¥ç»ç½‘ç»œ](https://zh.wikipedia.org/wiki/å‰é¦ˆç¥ç»ç½‘ç»œ)ï¼Œå®ƒçš„äººå·¥ç¥ç»å…ƒå¯ä»¥å“åº”ä¸€éƒ¨åˆ†è¦†ç›–èŒƒå›´å†…çš„å‘¨å›´å•å…ƒï¼Œ[[1\]](https://zh.wikipedia.org/wiki/å·ç§¯ç¥ç»ç½‘ç»œ#cite_note-deeplearning-1)å¯¹äºå¤§å‹å›¾åƒå¤„ç†æœ‰å‡ºè‰²è¡¨ç°ã€‚
>
> å·ç§¯ç¥ç»ç½‘ç»œç”±ä¸€ä¸ªæˆ–å¤šä¸ªå·ç§¯å±‚å’Œé¡¶ç«¯çš„å…¨è¿é€šå±‚ï¼ˆå¯¹åº”ç»å…¸çš„ç¥ç»ç½‘ç»œï¼‰ç»„æˆï¼ŒåŒæ—¶ä¹ŸåŒ…æ‹¬å…³è”æƒé‡å’Œæ± åŒ–å±‚ï¼ˆpooling layerï¼‰ã€‚è¿™ä¸€ç»“æ„ä½¿å¾—å·ç§¯ç¥ç»ç½‘ç»œèƒ½å¤Ÿåˆ©ç”¨è¾“å…¥æ•°æ®çš„äºŒç»´ç»“æ„ã€‚ä¸å…¶ä»–æ·±åº¦å­¦ä¹ ç»“æ„ç›¸æ¯”ï¼Œå·ç§¯ç¥ç»ç½‘ç»œåœ¨å›¾åƒå’Œ[è¯­éŸ³è¯†åˆ«](https://zh.wikipedia.org/wiki/è¯­éŸ³è¯†åˆ«)æ–¹é¢èƒ½å¤Ÿç»™å‡ºæ›´å¥½çš„ç»“æœã€‚è¿™ä¸€æ¨¡å‹ä¹Ÿå¯ä»¥ä½¿ç”¨[åå‘ä¼ æ’­ç®—æ³•](https://zh.wikipedia.org/wiki/åå‘ä¼ æ’­ç®—æ³•)è¿›è¡Œè®­ç»ƒã€‚ç›¸æ¯”è¾ƒå…¶ä»–æ·±åº¦ã€å‰é¦ˆç¥ç»ç½‘ç»œï¼Œå·ç§¯ç¥ç»ç½‘ç»œéœ€è¦è€ƒé‡çš„å‚æ•°æ›´å°‘ï¼Œä½¿ä¹‹æˆä¸ºä¸€ç§é¢‡å…·å¸å¼•åŠ›çš„æ·±åº¦å­¦ä¹ ç»“æ„[[2\]](https://zh.wikipedia.org/wiki/å·ç§¯ç¥ç»ç½‘ç»œ#cite_note-STANCNN-2)ã€‚

ç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ªä½¿ç”¨å·ç§¯è¿ç®—æ¥å¤„ç†æ•°æ®çš„ç¥ç»ç½‘ç»œã€‚åŒ…æ‹¬å·ç§¯å±‚ã€æ± åŒ–å±‚å’Œå…¨è¿æ¥å±‚ã€‚

åœ¨æ¯ä¸ªå·ç§¯å±‚ä¸Šéƒ½ä¼šæœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå·ç§¯æ ¸ï¼ˆ$kernel$ï¼‰æ¥å¯¹äºŒç»´åŒ–çš„æ•°æ®è¿›è¡Œæ‰«æå’Œå·ç§¯è¿ç®—ã€‚åœ¨æ± åŒ–å±‚ä¸Šä¼šå¯¹å·ç§¯åçš„æ•°æ®è¿›è¡Œå‹ç¼©ã€‚æœ€åå°±æ˜¯æ™®é€šç¥ç»å…ƒç½‘ç»œçš„å…¨è¿æ¥å±‚ã€‚

åœ¨å·ç§¯æ“ä½œæ—¶ï¼Œå·ç§¯æ ¸ä¼šå¯¹ $kernel\_size$ å†…çš„æ•°æ®æ¯ $stride$ ä¸€æ¬¡è¿›è¡Œå·ç§¯è¿ç®—ã€‚ä½†æ˜¯è¿™æ ·æ¯æ¬¡è¿ç®—å›¾ç‰‡éƒ½ä¼šå˜å°ï¼Œä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¼•å…¥äº† $padding$ï¼Œå³åœ¨åŸæ•°æ®å‘¨å›´åŠ ä¸Š $padding$ å±‚çš„ $0$ æ•°æ®ã€‚

ç½‘ä¸Šå…³äº CNN çš„ä»‹ç»æœ‰å¾ˆå¤šï¼Œè¿™é‡Œä¸å†åºŸè¯ï¼Œæœ‰æ¡ä»¶çš„å¯ä»¥çœ‹çœ‹[ä»€ä¹ˆæ˜¯å·ç§¯ç¥ç»ç½‘ç»œ CNN (Convolutional Neural Network)](https://morvanzhou.github.io/tutorials/machine-learning/torch/4-01-A-CNN/)

## æ•°æ®é›†å‡†å¤‡

è¿™é‡Œå›½å†…äº¤é€šæ ‡è¯†åˆ†ç±»æ•°æ®é›†æ¯”è¾ƒå°‘ï¼Œæˆ‘è¿™é‡Œåœ¨ [Chinese Traffic Sign Database](http://www.nlpr.ia.ac.cn/pal/trafficdata/recognition.html) ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ªæ•°æ®é›†ï¼Œå¯æƒœçš„æ˜¯æ•°æ®é›†æ¯”è¾ƒå°ï¼Œä¾›è®­ç»ƒçš„å›¾ç‰‡åªæœ‰ 4k+ å¼ ï¼Œè€Œä¸”åˆ†å¸ƒä¸å‡åŒ€ï¼Œ58 ä¸ªåˆ†ç±»ï¼Œæœ‰äº›åˆ†ç±»åªæœ‰å‡ åå¼ è®­ç»ƒå›¾ã€‚åªèƒ½åæœŸè¿›è¡Œæ•°æ®å¢å¼ºäº†ã€‚

ä¸‹è½½ä¸‹æ¥æ•°æ®é›†å’Œæ ‡è®°æ–‡ä»¶ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘å°†æ ‡è®°æ–‡ä»¶çš„æ ¼å¼æ”¹æˆäº†

```
path/fileName class
```

çš„æ ¼å¼ã€‚

ä» `torch.utils.data` å¯¼å…¥ `Dataset`ï¼Œæ ¹æ®[å®˜æ–¹æ–‡æ¡£](https://pytorch.org/docs/stable/data.html)ï¼Œå¯ä»¥è‡ªå®šä¹‰çš„æ•°æ®é›†æœ‰ä¸¤ç§ï¼Œ`map-style datasets` å’Œ `iterable-style datasets`ï¼Œè¿™é‡Œé€‰æ‹©äº†ç¬¬ä¸€ç§ï¼Œç„¶ååˆ›å»ºç»§æ‰¿è‡ª `Dataset` çš„æ•°æ®é›†ç±»ï¼Œåˆ›å»ºçš„æ•°æ®é›†åº”è¯¥åŒ…æ‹¬ä¸‰ä¸ªæ–¹æ³•ï¼š

```python
class trafficDataset(Dataset):
    def __init__(self, label_file_path, train=True):
    def __getitem__(self, index):
    def __len__(self):
```

åœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­ï¼Œéœ€è¦è¯»å–å›¾ç‰‡å’Œå…¶åˆ†ç±»ï¼Œåªéœ€è¯»å–æ ‡è¯†æ–‡ä»¶ä¸­çš„å›¾ç‰‡è·¯å¾„å’Œåˆ†ç±»å³å¯

```python
def __init__(self, label_file_path, train=True):
    f = open(label_file_path, 'r')
    self.data = list(map(lambda line: line.strip().split(' '), f)) # è¯»å–æ–‡ä»¶å’Œåˆ†ç±»
    self.train = train # æ ‡è®°æ˜¯å¦ç”¨äºè®­ç»ƒ
```

åœ¨ `__getitem__` æ–¹æ³•ä¸­ï¼Œéœ€è¦æ ¹æ®ç»™çš„ä¸‹æ ‡æ¥è¯»å–é€‰æ‹©çš„æ•°æ®ï¼Œè¿™é‡Œç”±äºä¹‹å‰è½½å…¥çš„ `data` æ˜¯å›¾ç‰‡è·¯å¾„å’Œåˆ†ç±»ï¼Œæ‰€ä»¥ `path, label = self.data[index]`ï¼Œç„¶åæ ¹æ®æ˜¯å¦ç”¨äºè®­ç»ƒå¯¹å›¾åƒåˆ†åˆ«å¤„ç†ã€‚è¿™é‡Œçš„å›¾ç‰‡å¤„ç†å’Œæ•°æ®å¢å¼ºéœ€è¦ç”¨åˆ° `torchvision` ä¸­çš„ `transforms` å’Œ `PIL` ä¸­çš„ `Image`ã€‚

```python
if self.train:
    # è®­ç»ƒé›†æ‰§è¡Œæ•°æ®å¢å¼º
    img = transforms.Compose([transforms.Resize((256, 256)), # ç»Ÿä¸€å°ºå¯¸
                              transforms.RandomRotation([-30, 30]), # åœ¨-30åº¦åˆ°30åº¦ä¹‹é—´éšæœºæ—‹è½¬
                              transforms.RandomGrayscale(0.3), # ä»¥0.3çš„æ¦‚ç‡å°†å›¾ç‰‡è½¬ä¸ºç°åº¦
                              transforms.ColorJitter(brightness=0.5, contrast=0.5), # éšæœºæ”¹å˜å›¾ç‰‡çš„äº®åº¦é¥±å’Œåº¦
                              transforms.ToTensor(), # å°†å›¾ç‰‡è½¬ä¸º Tensor æ ¼å¼
                              transforms.Normalize((0.485, 0.456, 0.406), (0.229, 0.224, 0.225)) # å›¾ç‰‡å½’ä¸€åŒ– 
                             ])(Image.open(path).convert('RGB'))
else:
    # æµ‹è¯•é›†ä¸æ‰§è¡Œ
    img = transforms.Compose([transforms.Resize((256, 256)),
                              transforms.ToTensor(),
                              transforms.Normalize((0.485, 0.456, 0.406), (0.229, 0.224, 0.225))
                             ])(Image.open(path).convert('RGB'))
```

ç„¶åå°†è·å¾—çš„ `img` å’Œ `lable` ä½œä¸ºè¿”å›å€¼ã€‚

`__len__` æ–¹æ³•ä¸ºè·å–æ•°æ®é›†é•¿åº¦ã€‚

## ä½¿ç”¨ pytorch æ„å»ºè‡ªå·±çš„ CNN ç½‘ç»œ

æ„å»ºæ•°æ®é›†ä¹‹åå°±æ˜¯å…³é”®çš„ CNN ç½‘ç»œçš„æ„å»ºï¼Œç”±äºåŒæ ·æ˜¯å›¾å½¢åˆ†ç±»ï¼Œè¿™é‡Œç½‘ç»œçš„æ„å»ºå¯ä»¥å‚è€ƒç½‘ä¸Šä¸€äº›ç»å…¸çš„ CNN ç½‘ç»œï¼Œæ¯”å¦‚ LeNet-5 ç½‘ç»œã€‚

è¦æ„å»ºç¥ç»å…ƒç½‘ç»œï¼Œé¦–å…ˆå¯¼å…¥ `torch` ä¸­çš„ `nn`ï¼Œç„¶åç»§æ‰¿ `nn.Module` æ„å»ºè‡ªå·±çš„ç¥ç»å…ƒç½‘ç»œç±»ï¼Œåº”è¯¥åŒ…å«ä¸¤ä¸ªæ–¹æ³•

``` python
class cnn(nn.Module):
    def __init__(self): # åˆå§‹åŒ–
        super(cnn, self).__init__()
	def forward(self, x): # æ­£å‘ä¼ æ’­
```

æŒ‰ç…§ä¸Šé¢è¯´çš„ä¸‰ä¸ªå±‚æ¬¡ï¼Œåœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­ä¾æ¬¡æ·»åŠ å·ç§¯å±‚ã€æ± åŒ–å±‚å’Œå…¨è¿æ¥å±‚ã€‚LeNet-5 ç½‘ç»œé™¤äº†è¿™ä¸‰ä¸ªä¹‹å¤–è¿˜åŒ…æ‹¬ä¸€ä¸ªæ¿€æ´»å±‚ã€‚

```python
class cnn(nn.Module):
    def __init__(self):
        super(cnn, self).__init__()
		self.conv1 = nn.Conv2d(in_channels=3, # å·ç§¯å±‚
                               out_channels=16,
                               kernel_size=5,
                               stride=1,
                               padding=2) 
        self.relu = nn.ReLU(inplace=True) # æ¿€æ´»å±‚
        self.maxpool = nn.MaxPool2d(kernel_size=2) # æ± åŒ–å±‚
        self.fc = nn.Liner(16*128*128, 58) # å…¨è¿æ¥å±‚
	def forward(self, x):
        x = self.conv1(x)
        x = self.relu(x)
        x = self.maxpool(x)
        x = x.reshape(x.size(0), -1)
        x = self.fc(x)
        return x
```

ä¸€ä¸ªç®€å•çš„ LeNet-5 ç½‘ç»œå°±æ­å»ºå®Œæˆäº†ã€‚åœ¨è¿™ä¸ªç½‘ç»œé‡Œåªè¿›è¡Œäº†ä¸€æ¬¡å·ç§¯ï¼Œå®é™…ä¸Šéœ€è¦ç”¨åˆ°çš„å·ç§¯å±‚å¯èƒ½æ›´å¤šï¼Œå¯ä»¥æ ¹æ®ä¸åŒéœ€æ±‚æ¥æ·»åŠ ã€‚

åŒæ—¶ä¸ºé¿å…è¿‡æ‹Ÿåˆé€šå¸¸ä¹Ÿä¼šæ·»åŠ  `dropout` ç­‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ `BN` å’Œ `dropout` ä¸€èˆ¬ä¸å¹¶ç”¨ï¼Œä¼¼ä¹æ˜¯ä¼šå¯¼è‡´æ–¹å·®åç§»ã€‚

æœ‰å…³äºå·ç§¯å±‚çš„è¾“å…¥å’Œè¾“å‡ºå°ºå¯¸é—®é¢˜ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå…¬å¼ï¼Œå‡è®¾ä¸€äº›å˜é‡ $H_i, W_i, D_i, H_o, W_o, D_o$ åˆ†åˆ«ä¸ºè¾“å…¥æ—¶çš„é•¿å®½æ·±å’Œè¾“å‡ºæ—¶çš„é•¿å®½æ·±ï¼Œ$C_i, C_o, K, S, P$ åˆ†åˆ«ä¸ºå·ç§¯å±‚çš„äº”ä¸ªå‚æ•°ã€‚

æœ‰ï¼š
$$
\begin{split}
H_o &= \left\lfloor\frac{H_i-K+2P}{S}\right\rfloor+1 \\\\
W_o &= \left\lfloor\frac{W_i-K+2P}{S}\right\rfloor+1 \\\\
D_o &= \left\lfloor\frac{D_i-K+2P}{S}\right\rfloor+1
\end{split}
$$
æ± åŒ–å±‚ä½¿ç”¨åŒä¸€ä¸ªå…¬å¼ã€‚

## è®­ç»ƒéƒ¨åˆ†

åœ¨æ•°æ®é›†å’Œç¥ç»ç½‘ç»œéƒ½æ­å»ºå®Œæˆä¹‹åï¼Œå°±å¯ä»¥å¼€å§‹è®­ç»ƒè‡ªå·±çš„æ¨¡å‹äº†ã€‚

å¼€å§‹ä¹‹å‰éœ€è¦åˆ›å»ºæ•°æ®é›†å¯¹è±¡

```python
full_data = trafficDataset(label_file_path='./Train/label_train.txt', train=True) # æŒ‡å®šè®­ç»ƒé›†å’ŒéªŒè¯é›†çš„æ•°æ®
train_size = int(0.9 * len(full_data)) 
vali_size = len(full_data) - train_size
# å°†è®­ç»ƒé›†çš„ä¸€éƒ¨åˆ†æ‹¿å‡ºæ¥ç”¨åšéªŒè¯
train_data, vali_data = torch.utils.data.random_split(full_data, [train_size, vali_size])

train_loader = DataLoader(train_data, batch_size=16, shuffle=True) # æ¯16ä¸ªä¸€æ‰¹è¿›è¡Œè®­ç»ƒï¼Œé¡ºåºéšæœº
vali_loader = DataLoader(vali_data, batch_size=16, shuffle=True)
```

> å¦‚æœéœ€è¦ä½¿ç”¨ GPU è¿›è¡Œè®­ç»ƒï¼Œéœ€è¦æŒ‡å®šæ¨¡å‹å¯¹è±¡å’Œæ•°æ®ä½¿ç”¨çš„è®¾å¤‡
>
> ```python
> device = torch.device('cuda:0' if torch.cuda.is_available() else 'cpu')
> model = cnn().to(device)
> ```

ç„¶åæŒ‡å®šç”¨äºåå‘ä¼ æ’­çš„ `loss` æ–¹æ³•ã€ä¼˜åŒ–å™¨ã€å­¦ä¹ ç‡å’Œ `epoch` ç­‰æ•°æ®ã€‚

```python
EPOCH = 50
LEARNING_RATE = 0.001 # å­¦ä¹ ç‡
loss_func = nn.CrossEntropyLoss() # äº¤å‰ç†µ
optimizer = torch.optim.AdamW(model.parameters(), lr=LEARNING_RATE, amsgrad=False, weight_decay=0.0005)
```
> å¦‚æœéœ€è¦æŒ‰ `epoch` è®¾ç½®åŠ¨æ€å­¦ä¹ ç‡ï¼Œå¯ä»¥ä½¿ç”¨ `torch.optim.lr_scheduler` ä¸­çš„æ–¹æ³•æ¥è®¾ç½®è¡°å‡ç‡ï¼Œç„¶ååœ¨æ¯ä¸ª `epoch` ç»“æŸåè¿›è¡Œ `scheduler.step()` æ¥æ”¹å˜å­¦ä¹ ç‡ã€‚
>
> âš  `scheduler` æ˜¯ `torch.optim.lr_scheduler.bulabula` çš„å¯¹è±¡

 ç„¶åå°±å¯ä»¥å¼€å§‹è®­ç»ƒäº†

```python
for epoch in range(EPOCH):
    torch.cuda.empty_cache()
    for step, (images, labels) in enumerate(train_loader):
        images = images.to(device) # å°†æ•°æ®é€åˆ°æŒ‡å®šè®¾å¤‡
        labels = labels.to(device)

        outputs = model(images) # è·å–é¢„æµ‹å€¼
        loss = loss_func(outputs, labels) # è·å–äº¤å‰ç†µ

        optimizer.zero_grad() # æ¢¯åº¦å½’é›¶
        loss.backward() # åå‘ä¼ æ’­
        optimizer.step() # æ¢¯åº¦æ›´æ–°
        # æ¯20æ¬¡è®­ç»ƒè¾“å‡ºä¸€æ¬¡
        if step % 20 == 0:
            print('Epoch [{}/{}], Step [{}/{}], Loss: {:.7f}'.format(epoch + 1, EPOCH, step + 1, total_step,
                                                                         loss.item()))
```

å¯ä»¥ä½¿ç”¨ç±»ä¼¼æµ‹è¯•çš„æ–¹æ³•å¯ä»¥åœ¨æ¯ä¸ª `epoch` åå¯¹éªŒè¯é›†è¿›è¡Œä¸€æ¬¡éªŒè¯ã€‚

è®­ç»ƒç»“æŸä¹‹åå¯ä»¥ä½¿ç”¨ `torch.save(model.state_dict(), 'model.pt')` æ¥å°†è®­ç»ƒå¥½çš„æ¨¡å‹ä¿å­˜åˆ°æœ¬åœ°ï¼Œä»¥ä¾¿æµ‹è¯•ã€‚

## æµ‹è¯•éƒ¨åˆ†

å¦‚æœæœ‰ä¿å­˜çš„æ¨¡å‹ï¼Œå…ˆä½¿ç”¨åˆ›å»ºä¸€ä¸ªæ¨¡å‹å¯¹è±¡ï¼Œå¹¶ä¸”ä½¿ç”¨ `model.load_state_dict(torch.load('model.pt'))` æ¥åŠ è½½ä¹‹å‰ä¿å­˜çš„æ¨¡å‹ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æ­£å¼å¼€å§‹æµ‹è¯•ä¹‹å‰ï¼Œè¦ä½¿ç”¨ `model.eval()` å…ˆå°†æ¨¡å‹å¯¹è±¡çš„æ¨¡å¼æ”¹æˆè¯„ä¼°ã€‚

``` python
for images, labels in test_loader:
    images, labels = images.to(device), labels.to(device)
    with torch.no_grad():
        outputs = model(images) # è·å–é¢„æµ‹
        maxk = max((1, 5))
        labels_resize = labels.view(-1, 1)
        _, predicted = outputs.topk(maxk, 1, True, True) # è·å–å¯èƒ½æ€§æœ€å¤§çš„5ä¸ªç±»åˆ«
        correct += torch.eq(predicted, labels_resize).sum().item()
        total += labels.size(0)
```

è¿™é‡Œé‡‡ç”¨ top-5 çš„é¢„æµ‹æ–¹å¼æ¥é¢„æµ‹ç±»åˆ«ã€‚

## ç¬¬ä¸€ä¸ªæ¨¡å‹

ç¬¬ä¸€ä¸ªæ¨¡å‹ç”¨äº†4ä¸ªå·ç§¯å±‚ã€æ¿€æ´»å±‚ã€æ± åŒ–å±‚å’Œä¸€ä¸ªå…¨è¿æ¥å±‚ï¼Œæ²¡æœ‰æ•°æ®å¢å¼ºã€‚åœ¨å­¦ä¹ ç‡ 0.01 çš„æƒ…å†µä¸‹ä½¿ç”¨ Adam ä¼˜åŒ–å™¨è·‘äº† 50 ä¸ª epochï¼Œç»“æœå¹¶ä¸ç†æƒ³ï¼Œå¤§æ¦‚åªæœ‰50å·¦å³çš„æ­£ç¡®ç‡ã€‚

åœ¨åé¢å¯¹è®­ç»ƒé›†è¿›è¡Œæ•°æ®å¢å¼ºåï¼Œæ­£ç¡®ç‡æé«˜åˆ° 80 ä»¥ä¸Šï¼Œä½†æ˜¯ä¼¼ä¹ f1 åˆ†æ•°ä¸é«˜ï¼Œè¿™å¯æŠŠæˆ‘è¿™ä¸ªæ²¡ç»éªŒçš„ğŸ‘¶ğŸ‘¶æ€¥åäº†ã€‚

äºæ˜¯ï¼Œåœ¨å¤šæ–¹å’¨è¯¢å’Œèˆå‹å»ºè®®ä¸‹ï¼Œæˆ‘å°†æˆ‘çš„ CNN ç½‘ç»œæ”¹ä¸ºäº† ResNetã€‚

## ä»€ä¹ˆæ˜¯ ResNet

æ·±åº¦æ®‹å·®ç½‘ç»œï¼ˆDeep residual network, ResNetï¼‰æ˜¯ç”±ä½•å‡¯æ˜å›¢é˜Ÿåœ¨2015å¹´æå‡ºçš„ä¸€ç§å·ç§¯ç¥ç»ç½‘ç»œã€‚å…¶ä½¿ç”¨æ®‹å·®å­¦ä¹ çš„æ–¹å¼æ¥è§£å†³æ·±å±‚ç½‘ç»œé€€åŒ–çš„é—®é¢˜ã€‚

![æ®‹å·®å­¦ä¹ å•å…ƒ](https://masterenlu.github.io/blogSite/img/æ®‹å·®å­¦ä¹ .png)

å°†è¾“å…¥ $x$ çš„ç‰¹å¾è®°ä¸º $H(x)$ï¼Œé‚£ä¹ˆå¯¹äºè¿™ä¸ª $x$ï¼Œ æ®‹å·®ä¸º $F(x)=H(x)-x$ï¼Œé‚£ä¹ˆè¿™ä¸ªç‰¹å¾å°±æ˜¯ $H(x)=F(x)+x$ã€‚

ResNet å‚è€ƒå¹¶ä¿®æ”¹äº† VGG19 çš„ç½‘ç»œç»“æ„ï¼ŒåŠ å…¥äº†æ®‹å·®å•å…ƒã€‚

å…·ä½“åœ¨[è®ºæ–‡](https://arxiv.org/abs/1512.03385)é‡Œå¯ä»¥çœ‹ ~~ï¼ˆæ‡’å¾—å†™äº†~~ã€‚

## ResNet ç½‘ç»œçš„æ­å»º

### pytorch å®˜æ–¹å®ç°

åœ¨ pytorch å®˜æ–¹åº“é‡Œæœ‰ ResNet çš„å®ç°ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å‚ç…§ä¸€ä¸‹ï¼Œæºç åœ¨ [Github](https://github.com/pytorch/vision/blob/master/torchvision/models/resnet.py) ä¸Šå¯ä»¥æ‰¾åˆ°ã€‚

### è‡ªå®šä¹‰æ­å»º

è¿™é‡Œä¸»è¦æ˜¯åœ¨å®˜æ–¹çš„ä»£ç ä¸Šç¨å¾®æ”¹äº†ä¸€ä¸‹ï¼Œç”±äºåªç”¨åˆ°äº† resnet50ï¼Œæ‰€ä»¥æ®‹å·®å—å°±åªè®¾ç½®äº†ä¸€ä¸ªï¼Œå‚æ•°ä¹Ÿå–æ¶ˆæ‰äº†ã€‚

æ®‹å·®å—ï¼š

```python
class BasicBlock(nn.Module):
    def __init__(self, in_num, num, stride):
        super(BasicBlock, self).__init__()
        self.stride = stride
        self.conv1 = nn.Sequential(
            nn.Conv2d(in_num, num, kernel_size=1, bias=False),
            nn.BatchNorm2d(num),
            nn.ReLU(inplace=True)
        )
        self.conv2 = nn.Sequential(
            nn.Conv2d(num, num, kernel_size=3, stride=self.stride, padding=1, bias=False),
            nn.BatchNorm2d(num),
            nn.ReLU(inplace=True)
        )
        self.conv3 = nn.Sequential(
            nn.Conv2d(num, num * 4, kernel_size=1, bias=False),
            nn.BatchNorm2d(num * 4)
        )

        self.conv4 = nn.Sequential()
        if in_num != num * 4 or stride != 1:
            self.conv4 = nn.Sequential(
                nn.Conv2d(in_num, num * 4, kernel_size=1, stride=self.stride, bias=False),
                nn.BatchNorm2d(num * 4)
            )

    def forward(self, x):
        y = self.conv1(x)
        y = self.conv2(y)
        y = self.conv3(y)
        residual = self.conv4(x)
        return nn.ReLU(inplace=True)(residual + y)
```



## ç¬¬äºŒä¸ªæ¨¡å‹

åœ¨æ”¹ä¸º ResNet ç½‘ç»œä¹‹åï¼Œ0.001 å­¦ä¹ ç‡ç”¨ adamw è·‘äº† 15 ä¸ªepochï¼Œç»“æœå¦‚å›¾

![æ¨¡å‹äºŒåˆ†æ•°](https://masterenlu.github.io/blogSite/img/æ¨¡å‹äºŒåˆ†æ•°.png)

![æ¨¡å‹äºŒloss](https://masterenlu.github.io/blogSite/img/æ¨¡å‹äºŒ_loss.png)

æµ‹è¯•é›†å‡†ç¡®ç‡å¯ä»¥åˆ°92ï¼Œä½†æ˜¯è¿™ä¸ª loss æ³¢åŠ¨æœ‰ç‚¹å¤¸å¼ ï¼Œäºæ˜¯æˆ‘å°†å­¦ä¹ ç‡æ”¹æˆ 0.01ï¼Œè·‘äº† 50 ä¸ª epochï¼Œç»“æœå¦‚å›¾

![AdamW åˆ†æ•°](https://masterenlu.github.io/blogSite/img/AdamW_Score.png)

å®é™…ä¸Šè¿™ä¸ªæ˜¯æ‰‹æ»‘äº†ï¼Œæœ¬æ¥æƒ³ç”¨ SGD çš„ï¼Œç»“æœå­¦ä¹ ç‡å•¥çš„æ”¹äº†ï¼Œä¼˜åŒ–å™¨æ²¡æ”¹ã€‚

![SGD åˆ†æ•°](https://masterenlu.github.io/blogSite/img/SGD_Score.png)

æ„Ÿè§‰è¿˜æ˜¯å¯ä»¥çš„ï¼Œè‡³å°‘ä½œä¸ºæˆ‘ç¬¬ä¸€ä¸ª AI æ¨¡å‹æ¥è¯´ï¼Œåº”è¯¥ç®—æ˜¯æ¯”è¾ƒæˆåŠŸäº†ã€‚

## ä½œå›¾

æœ¬æ¥æ˜¯ä¸æƒ³ç”»å›¾çš„ï¼Œä½†æ˜¯è¦çœ‹ä¸€ä¸ªå‚æ•°çš„èµ°å‘ï¼Œæ‰€ä»¥å°±å­¦ä¹ äº†ä¸€ä¸‹ã€‚

### å¤šå­å›¾

ç”±äºè¦ä½œå‡ ä¸ªåˆ†æ•°å’Œ loss çš„å˜åŒ–æ›²çº¿ï¼Œä¸€ä¸ªæ›²çº¿å›¾çœ‹èµ·æ¥å¯èƒ½ä¼šå¾ˆæŒ¤ï¼Œè€Œä¸”å‡ ä¸ªåˆ†æ•°çš„å€¼éƒ½å·®ä¸å¤šï¼Œä¼šé‡å ï¼Œæ‰€ä»¥å°±åšæˆäº†å¤šå­å›¾çš„å½¢å¼ã€‚

é¦–å…ˆå®šä¹‰ä¸€ä¸‹ `figure` çš„å°ºå¯¸å’Œ dpiï¼š`plt.figure(figsize=(10, 10), dpi=100)`

ç„¶åè¿™é‡Œå®šä¹‰ä¸€ä¸‹ç½‘æ ¼åˆ†å¸ƒï¼š`grid = plt.GridSpec(3, 2, wspace=0.2, hspace=0.5)`ï¼Œæ€»å…±æ˜¯ä¸‰è¡Œä¸¤åˆ—ã€‚

ä½¿ç”¨ `subplot()` å¯ä»¥åˆ›å»ºå­å›¾ï¼Œåœ¨åˆ›å»ºçš„åŒæ—¶æŒ‡å®šå­å›¾çš„å¸ƒå±€å°±è¡Œäº†ï¼Œæ¯”å¦‚ï¼š`plt.subplot(grid[0, 0])` å°±æ˜¯åœ¨ç¬¬ä¸€è¡Œç¬¬ä¸€åˆ—çš„åœ°æ–¹æ–°å»ºä¸€ä¸ªå­å›¾ã€‚å¦‚æœéœ€è¦è·¨å¤šä¸ªç½‘æ ¼ï¼Œå¯ä»¥ä½¿ç”¨ `start:len` çš„æ ¼å¼ï¼Œæ¯”å¦‚ `plt.subplot(grid[2, 0:2])` å°±æ˜¯åœ¨ç¬¬ 3 è¡Œç¬¬ 1 åˆ° 2 åˆ—çš„åœ°æ–¹æ–°å»ºä¸€ä¸ªå­å›¾ã€‚

è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œå¦‚æœè¦å®šä¹‰å­å›¾çš„åç§°ï¼Œéœ€è¦ä½¿ç”¨çš„æ–¹æ³•**æ˜¯** `title()` è€Œ**ä¸æ˜¯** `subtitle()`ã€‚

ä½¿ç”¨ `plot(x,y)` æŒ‡ä»¤å°±å¯ä»¥ä½œå›¾äº†ã€‚

ä¹‹åä½¿ç”¨  `show()` æŒ‡ä»¤å°±å¯ä»¥æ˜¾ç¤ºå›¾è¡¨ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœåœ¨å­å›¾å®šä¹‰å®Œæˆä¹‹å‰å°±ä½¿ç”¨ `show()`ï¼Œå¯èƒ½ä¼šæ‰“ä¹±è®¾å®šçš„æ ¼å¼ã€‚

### æ¨ªå‘æŸ±çŠ¶å›¾

æƒ³åšä¸€ä¸‹é¢„æµ‹ä¸€å¼ å›¾ç‰‡çš„æ—¶å€™æ˜¾ç¤ºçš„ç»“æœï¼ŒæŒ‰ç…§é¢„æƒ³çš„ï¼Œç»“æœå›¾åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œå·¦è¾¹ç¬¬ä¸€éƒ¨åˆ†æ˜¯åŸå›¾ç‰‡ï¼Œå³è¾¹åˆ™æ˜¯ä»å°åˆ°å¤§æ’åˆ—çš„å¯èƒ½çš„ç»“æœã€‚

è¿™ä¸ªå¯ä»¥é€šè¿‡ä¸Šé¢çš„å¤šå­å›¾æ¥å®ç°ï¼Œä¸å¤šè¯´ã€‚

ä¸»è¦æ˜¯è¿™ä¸ªæ¨ªå‘æŸ±çŠ¶å›¾ã€‚å…¶å®å°±æ˜¯æŠŠ `x`ï¼Œ`y` è½´é¢ å€’äº†ä¸€ä¸‹ã€‚

ç›´æ¥ä½¿ç”¨ `barh(x,y,align='center')` æ¥ä½œå›¾ï¼Œè¿™é‡Œçš„ `x` ä»£è¡¨çºµè½´ï¼Œ`y` ä»£è¡¨æ¨ªè½´ï¼Œ`align` è¡¨ç¤ºä¸‹è¡¨æ˜¯å¦å±…ä¸­ã€‚ä½¿ç”¨ `axis('off')` å¯ä»¥å…³é—­å›¾åƒçš„åæ ‡ï¼Œå¯ä»¥åœ¨ä½œåŸå›¾åƒå­å›¾æ—¶ç”¨åˆ°ã€‚

è¿™é‡Œç”±äº `x` å…¨æ˜¯æ•°å­—ï¼Œéœ€è¦è½¬æ¢æˆå¯¹åº”çš„ç±»åï¼Œå¯ä»¥ä½¿ç”¨  `yticks(index, label)` æ¥æ”¹å˜çºµè½´ä¸Šæ•°å€¼çš„åç§°ï¼Œå°† `index` æ”¹ä¸º `label`ã€‚

å®Œæˆçš„æ•ˆæœï¼š
![predicted result](https://masterenlu.github.io/blogSite/img/redicted_result.png)

## ç»“å°¾

çœŸæ­£çš„ä»é›¶å¼€å§‹åšä¸€ä¸ªä¸œè¥¿ï¼Œæ€»å…±ç®—ä¸‹æ¥å¤§æ¦‚èŠ±äº†ä¸¤ä¸ªå‘¨æœ«æ¥å®Œæˆè¿™ä¸ªæ¨¡å‹ï¼ŒæœŸé—´ç‹‚å¬ Aimerï¼Œå·²ç»æ²‰è¿·äºè¿™ä¸ªç”œç¾çš„æ—…äººã€‚

ä»çš„æ¥è¯´æ„Ÿè§‰è¿˜æ˜¯æŒºä¸é”™çš„ï¼Œå¥½æ­¹å­¦åˆ°äº†ä¸€äº›ä¸œè¥¿ ~~ï¼ˆæŒ‡ç‹‚å¬ Aimer~~ï¼Œæ¯”åœ¨å®¶é—²ç€æ‘¸é±¼å¼ºã€‚